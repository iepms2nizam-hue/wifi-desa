export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    
    // Homepage
    if (url.pathname === '/' && !url.searchParams.has('url')) {
      return new Response(getHomePage(), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' }
      });
    }
    
    // Handle proxy path: /proxy/https://example.com/path
    let targetUrl = url.searchParams.get('url');
    
    if (url.pathname.startsWith('/proxy/')) {
      targetUrl = url.pathname.slice(7) + url.search;
    }
    
    if (!targetUrl) {
      return new Response('No URL', { status: 400 });
    }
    
    try {
      targetUrl = decodeURIComponent(targetUrl);
      if (!targetUrl.startsWith('http')) {
        targetUrl = 'https://' + targetUrl;
      }
      
      const targetURL = new URL(targetUrl);
      
      // Clone headers, modify untuk bypass
      const headers = new Headers();
      headers.set('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
      headers.set('Accept', request.headers.get('Accept') || 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8');
      headers.set('Accept-Language', 'en-US,en;q=0.9');
      headers.set('Referer', targetURL.origin);
      headers.set('Origin', targetURL.origin);
      
      // Fetch
      const response = await fetch(targetURL.href, {
        method: request.method,
        headers: headers,
        body: request.method !== 'GET' ? request.body : undefined,
        redirect: 'follow'
      });
      
      const contentType = response.headers.get('Content-Type') || '';
      
      // HTML
      if (contentType.includes('text/html')) {
        let html = await response.text();
        html = rewriteHtml(html, targetURL, url.origin);
        
        return new Response(html, {
          status: response.status,
          headers: buildHeaders('text/html; charset=utf-8')
        });
      }
      
      // CSS
      if (contentType.includes('text/css')) {
        let css = await response.text();
        css = rewriteCss(css, targetURL, url.origin);
        
        return new Response(css, {
          headers: buildHeaders('text/css')
        });
      }
      
      // JavaScript - rewrite URLs dalam JS
      if (contentType.includes('javascript')) {
        let js = await response.text();
        js = rewriteJs(js, targetURL, url.origin);
        
        return new Response(js, {
          headers: buildHeaders('application/javascript')
        });
      }
      
      // Video/Media - stream through
      if (contentType.includes('video') || contentType.includes('audio') || contentType.includes('mpegurl') || contentType.includes('dash')) {
        return new Response(response.body, {
          status: response.status,
          headers: {
            'Content-Type': contentType,
            'Access-Control-Allow-Origin': '*',
            'Cache-Control': 'public, max-age=3600'
          }
        });
      }
      
      // Other - passthrough
      return new Response(response.body, {
        status: response.status,
        headers: {
          'Content-Type': contentType,
          'Access-Control-Allow-Origin': '*'
        }
      });
      
    } catch (e) {
      return new Response(`Error: ${e.message}`, { status: 500 });
    }
  }
};

function buildHeaders(contentType) {
  return {
    'Content-Type': contentType,
    'Access-Control-Allow-Origin': '*',
    'X-Content-Type-Options': 'nosniff'
  };
}

function rewriteHtml(html, targetURL, proxyOrigin) {
  const base = targetURL.origin;
  
  // Rewrite href, src, action, poster, data-src
  html = html.replace(/(href|src|action|poster|data-src|data-lazy-src)=["']([^"']+)["']/gi, (match, attr, value) => {
    if (value.startsWith('data:') || value.startsWith('javascript:') || value.startsWith('#')) {
      return match;
    }
    const absoluteUrl = resolveUrl(value, targetURL);
    return `${attr}="${proxyOrigin}/proxy/${encodeURIComponent(absoluteUrl)}"`;
  });
  
  // Rewrite srcset
  html = html.replace(/srcset=["']([^"']+)["']/gi, (match, value) => {
    const parts = value.split(',').map(part => {
      const [url, size] = part.trim().split(/\s+/);
      const absoluteUrl = resolveUrl(url, targetURL);
      return `${proxyOrigin}/proxy/${encodeURIComponent(absoluteUrl)}${size ? ' ' + size : ''}`;
    });
    return `srcset="${parts.join(', ')}"`;
  });
  
  // Rewrite CSS url()
  html = html.replace(/url\(["']?([^"')]+)["']?\)/gi, (match, value) => {
    if (value.startsWith('data:')) return match;
    const absoluteUrl = resolveUrl(value, targetURL);
    return `url("${proxyOrigin}/proxy/${encodeURIComponent(absoluteUrl)}")`;
  });
  
  // Inject script untuk intercept fetch/XHR
  const injectedScript = `
<script>
(function() {
  const PROXY_BASE = "${proxyOrigin}/proxy/";
  const ORIGINAL_ORIGIN = "${targetURL.origin}";
  
  // Override fetch
  const originalFetch = window.fetch;
  window.fetch = function(url, options) {
    if (typeof url === 'string' && !url.startsWith('data:')) {
      url = PROXY_BASE + encodeURIComponent(new URL(url, ORIGINAL_ORIGIN).href);
    }
    return originalFetch.call(this, url, options);
  };
  
  // Override XMLHttpRequest
  const originalOpen = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(method, url, ...args) {
    if (typeof url === 'string' && !url.startsWith('data:')) {
      url = PROXY_BASE + encodeURIComponent(new URL(url, ORIGINAL_ORIGIN).href);
    }
    return originalOpen.call(this, method, url, ...args);
  };
})();
</script>`;
  
  html = html.replace('<head>', '<head>' + injectedScript);
  
  return html;
}

function rewriteCss(css, targetURL, proxyOrigin) {
  return css.replace(/url\(["']?([^"')]+)["']?\)/gi, (match, value) => {
    if (value.startsWith('data:')) return match;
    const absoluteUrl = resolveUrl(value, targetURL);
    return `url("${proxyOrigin}/proxy/${encodeURIComponent(absoluteUrl)}")`;
  });
}

function rewriteJs(js, targetURL, proxyOrigin) {
  // Basic URL rewriting dalam JS - tak perfect tapi boleh help
  // Rewrite absolute URLs ke origin
  js = js.replace(new RegExp(escapeRegex(targetURL.origin), 'g'), proxyOrigin + '/proxy/' + encodeURIComponent(targetURL.origin));
  return js;
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function resolveUrl(value, baseURL) {
  try {
    if (value.startsWith('//')) {
      return baseURL.protocol + value;
    }
    if (value.startsWith('/')) {
      return baseURL.origin + value;
    }
    if (value.startsWith('http')) {
      return value;
    }
    return new URL(value, baseURL.href).href;
  } catch {
    return value;
  }
}

function getHomePage() {
  return `<!DOCTYPE html>
<html>
<head>
  <title>üîí My Private Proxy</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0f0f23 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 24px;
      padding: 50px 40px;
      max-width: 550px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    }
    .logo { font-size: 48px; text-align: center; margin-bottom: 10px; }
    h1 {
      color: #fff;
      text-align: center;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .subtitle {
      color: rgba(255,255,255,0.5);
      text-align: center;
      margin-bottom: 35px;
      font-size: 14px;
    }
    .input-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: 100%;
      padding: 18px 20px;
      padding-right: 100px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 14px;
      font-size: 16px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      transition: all 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 20px rgba(99,102,241,0.3);
    }
    input::placeholder { color: rgba(255,255,255,0.3); }
    button {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      padding: 12px 24px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 5px 20px rgba(99,102,241,0.4);
    }
    .features {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 30px;
    }
    .feature {
      background: rgba(255,255,255,0.03);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }
    .feature-icon { font-size: 24px; margin-bottom: 8px; }
    .feature-text { color: rgba(255,255,255,0.6); font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üõ°Ô∏è</div>
    <h1>Private Web Proxy</h1>
    <p class="subtitle">Browse securely ‚Ä¢ No logs ‚Ä¢ No tracking</p>
    
    <form onsubmit="go(event)">
      <div class="input-wrapper">
        <input type="text" id="url" placeholder="Enter website URL..." autocomplete="off" autofocus>
        <button type="submit">Browse</button>
      </div>
    </form>
    
    <div class="features">
      <div class="feature">
        <div class="feature-icon">üîí</div>
        <div class="feature-text">Self-hosted</div>
      </div>
      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-text">Fast CDN</div>
      </div>
      <div class="feature">
        <div class="feature-icon">üö´</div>
        <div class="feature-text">No Malware</div>
      </div>
      <div class="feature">
        <div class="feature-icon">üåç</div>
        <div class="feature-text">Bypass Block</div>
      </div>
    </div>
  </div>
  
  <script>
    function go(e) {
      e.preventDefault();
      let url = document.getElementById('url').value.trim();
      if (!url) return;
      if (!url.startsWith('http')) url = 'https://' + url;
      window.location.href = '/proxy/' + encodeURIComponent(url);
    }
  </script>
</body>
</html>`;
}
